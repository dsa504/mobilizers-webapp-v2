<template id="intake-form">
  <form class="intake-form active" v-on:input="onPmChange">
    <md-card class="login-card">
      <md-toolbar :md-elevation="1">
        <md-icon>face</md-icon>
        <span class="md-title">Program Member Details</span>
      </md-toolbar>
      <md-card-content>
        <div class="pm_details">
          <ul class="mdl-list">
            <li><b>Name: {{ pm.name }}</b></li>
            <li>Phone: {{ pm.phone }}</li>
            <li>Email: {{ pm.email }}</li>
          </ul>
          <ul class="mdl-list">
            <li>Assigned Date: {{ pm.assigned }}</li>
            <li>Due Date: <b>{{ pm.due }}</b></li>
            <li>Status: {{ pm.status }}</li>
          </ul>
        </div>
      </md-card-content>
    </md-card>

    <md-card class="step_box">
      <md-toolbar :md-elevation="1">
        <span class="md-title">Initial Text</span>
      </md-toolbar>
      <md-card-content>
        <div class="speech-bubble-text">
          "Hi <b>{{ pm.name }}</b>! This is <b>{{ pm.mobilizer }}</b> from New Orleans DSA. We got your info from our site and we'd love to talk to you. Do you have time today or soon for a phone call?"
        </div>
        
        <div class="checkbox_wrap">
          <md-checkbox v-model="pm.initalTextSent" :value="true">Text Sent?</md-checkbox>
        </div>
        
        <div class="response_text">Program Member Response:</div>
        <md-field>
          <md-select v-model="pm.initialTextResponse">
            <md-option 
              v-for="response in presets.initialTextResponses" 
              :key="response" 
              :value="response"
            >{{ response }}</md-option>
          </md-select>
        </md-field>
      </md-card-content>
    </md-card>
  
    <md-card class="step_box" v-if="showSteps">
      <md-toolbar :md-elevation="1">
        <span class="md-title">Intake Call</span>
      </md-toolbar>
      <md-card-content>
        <h3>“Hi, is this <b>{{ pm.name }}</b>?”</h3>
        <div class="response_text">Program Member Response:</div>
        <md-radio v-model="programMemberInfo.callMade" value="Yup!">Yup!</md-radio>
        <md-radio v-model="programMemberInfo.callMade" value="No Answer/Left Message">No Answer/Left Message</md-radio>
      </md-card-content>
      
      <md-divider></md-divider>
      
      <md-card-content>
        <h3>Introduce yourself</h3>
        <div class="speech-bubble">
          “This is <b>{{ pm.mobilizer }}</b> from the DSA New Orleans mobilizers program - I’ve been assigned to you though the program, to act as a point of contact for you to DSA New Orleans, to answer any questions you might have, and help you get involved. First though I’ve just got a couple quick questions, if that’s cool?”
        </div>
      </md-card-content>
      
      <md-divider></md-divider>
      
      <md-card-content>
        <h3>Identify Pronoun &amp; Occupation</h3>
        <div class="speech-bubble">
          “Could I get the pronoun you're called by (she/he/they/etc), and your occupation?"
        </div>
        <div class="response_text">Program Member Response:</div>
        <md-field>
          <label for="pronoun">Enter Pronoun</label>
          <md-input id="pronoun" v-model="pm.pronoun"></md-input>
        </md-field>
        <md-field>
          <label for="occupation">Enter Occupation</label>
          <md-input id="occupation" v-model="pm.occupation"></md-input>
        </md-field>
      </md-card-content>
      
      <md-divider></md-divider>
      
      <md-card-content>
        <h3>Identify pre-existing committee or project interest</h3>
        <div class="speech-bubble">
          “I’m not sure if you’re familiar with any of our committees, or projects we’ve been working on, but if you are, is there a specific committee or project we’re involved in that you know you’d be interested in?”
        </div>
        <div class="response_text">Program Member Response:</div>
        <md-checkbox 
          v-for="interest in presets.programsAndCommittees" 
          :key="interest" 
          :value="interest" 
          v-model="tempData.interests"  
          name="interests"
        >{{ interest }}</md-checkbox>
      </md-card-content>
      
      <md-divider></md-divider>
      
      <md-card-content>
        <h3>Identify additional skills/resources</h3>
        <div class="speech-bubble">
          “Do you have any additional skills or experience that you’d be interested in contributing- like design, photography, writing, childcare, etc?”
        </div>
        <div class="response_text">Write any additional skills or interests here:</div>
        <md-field>
          <label for="skills">Enter Skills\Resources</label>
          <md-textarea 
          id="skills" 
          v-model="pm.skills"
          ></md-textarea>   
        </md-field>
      </md-card-content>
      
      <md-divider></md-divider>
      
      <md-card-content>
        <h3>Answer any questions</h3>
        <div class="speech-bubble">
          “OK, so do you have any questions about DSA?”
        </div>
        <em>
          (If somebody asks a question you’re not sure about, note it, say “Honestly, I’m not sure- let me check on that and get back to you.” and post the question in the #mobilizerdesk channel so you can text back an answer later)
          <br/>
          <br/>
        </em>
        <div class="speech-bubble">
          “If you think of any any other questions, just text me at this number.”
        </div>
      </md-card-content>
      
      <md-divider></md-divider>
      
      <md-card-content>
        <h3>Schedule Meetup</h3>
        <div class="speech-bubble">
          “Alright, so if you’re still interested in getting involved in DSA, one of the best ways is to come to a <b>[social/general meeting]</b>- I’ll be at the next one at <b>[location]</b> on <b>[date/time]</b>- it’s a great way to meet some of the members, meet the committee stewards/leadership, etc. and see what we’re all about. Think you could make that?”
        </div>
        <div class="response_text">Program Member Response:</div>
        <md-field>
          <md-select v-model="pm.meetupScheduled">
            <md-option v-for="opt in presets.meetingScheduledResponses" :key="opt" :value="opt">{{ opt }}</md-option>
          </md-select>
        </md-field>
        <md-field>
          <label for="meetup_event">Enter Event {{pm.name}} Says They'll Attend</label>
          <md-input v-model="pm.meetupEvent" placeholder='Enter Meetup Event'></md-input>
        </md-field>
        <div class="speech-bubble">"Bye, and thanks for your time!"</div>
      </md-card-content>
    </md-card>
  
    <md-card class="step_box" v-if="showSteps">
      <md-toolbar :md-elevation="1">
        <span class="md-title">Followup Text</span><br/>
        <span class="md-subhead">(Send 24-48 hours after intake call)</span>
      </md-toolbar>
      <md-card-content>
        <div class="speech-bubble-text">
          “Hey <b>{{pm.name}}</b> - was really nice talking to you the other day, just wanted to follow up to make sure you had the details of our <b>[social/general]: [location/date/time]</b>. Hope to see you there!"
        </div>
        <md-checkbox v-model="pm.followupTextSent" :value="true">Text Sent?</md-checkbox>
      </md-card-content>
    </md-card>
  
    <md-card class="step_box" v-if="showSteps">
      <md-toolbar :md-elevation="1">
        <span class="md-title">Meetup</span>
      </md-toolbar>
      <md-card-content>
        <div class="response_text">Meetup Guidelines</div>
        <ul>
          <li>We’ll make an announcement at the event, but <b>find your program members and introduce yourself!</b></li>
          <li>Keep an open mind and be friendly</li>
          <li><b>Learn about your program members</b>- their interests, best way to contact, availability, etc</li>
          <li><b>Make introductions</b>- particularly to members that share interests, professions or are in committees your program member has expressed interest in </li>
          <li>Explain Slack, how we use it, and <b>ask if the Program Member would like to be added</b></li>
          <li><b>Explain basic stuff</b>- committee/leadership structures, general meetings, grievance policy, etc</li>
          <li><b>Answer any questions</b>; if you’re not sure, note and contact #mobilizerdesk (or ask around the event- if the question is pertinent to a specific committee or project, it can be an opportunity to introduce the program member to a active member.)</li>
        </ul>
        <div class="response_text">Please check the following:</div>
        <md-checkbox v-model="pm.attendedMeetup" :value="true">Attended General or Social</md-checkbox>
        <md-checkbox v-model="pm.metPm" :value="true"> Met <b>{{ pm.name}}</b></md-checkbox>
        <md-checkbox v-model="pm.addToSlack" :value="true">Add <b>{{ pm.name}}</b> to Slack</md-checkbox>
      </md-card-content>
    </md-card>
  
    <md-card class="step_box">
      <md-toolbar :md-elevation="1">
        <span class="md-title">Complete This Mobilization</span>
      </md-toolbar>
      <md-card-content>
        <div class="response-text">If you've completed this mobilization (or this program member wasn't interested or not reachable), click below to close this assignment.</div>
      </md-card-content>
      <md-card-actions>
        <md-switch 
          id="mark_as_done" 
          class="md-raised"
          v-model="pm.done" 
        >
          <span v-if="!pm.done">Mark as Done</span>
          <span v-if="pm.done">Marked Done</span>
        </md-switch>
      </md-card-actions>
    </md-card>

    <md-card class="step_box md-accent">
      <md-toolbar :md-elevation="1">
        <span class="md-title">Sketch Alert</span>
      </md-toolbar>
      <md-card-content>
        <div style="padding-bottom:20px;">If at any point the person you're mobilizing makes you uncomfortable, or if you suspect they may be an infiltrator, cop or other bad actor, please stop the process and click the checkbox below!</div>
        <md-checkbox v-model="pm.sketch" :value="true" class="md-accent"><b>Mark as Sketch</b></md-checkbox>
      </md-card-content>
    </md-card>

  </form>
</template>

<script>
  (function() {
    window.vueComponents = window.vueComponents || {};

    function copyArray(arr) {
      return arr.reduce(function(m, el) {
        m.push(el);

        return m;
      }, []);
    }

    function absorbObjValues(targetObj, sourceObj) {
      var sourceKeys = Object.keys(sourceObj);
      for (var i = 0; i < sourceKeys.length; i++) {
          var k = sourceKeys[i];
          targetObj[k] = (Array.isArray(sourceObj[k])) 
            ? copyArray(sourceObj[k]) 
            : sourceObj[k];
      }
    }

    window.vueComponents.intakeForm = {
      template: "#intake-form",
      props: {
        presets: { type: Object, required: true },
        // external program member object. don't change this one:
        programMember: { type: Object, required: true }, 
      },
      data: function() { return {
        // internal program member representation. this is the one we actually use:
        pm: {},
      };},
      methods: {
        onPmChange: function(e) {
          console.log(e);
        },
      },
      computed: {
        showSteps: function() {
          return this.pm.done || this.pm.sketch;
        },
      },
      watch: {
        programMember: function(newVal, oldVal) {
          if (newVal === oldVal)

          // prevent mutating data on this component's parent Vue instance:
          absorbObjValues(this.pm, this.programMember);
        },
      },
      beforeCreate: function() {
        absorbObjValues(this.pm, this.programMember);
      },
      created: function() {
        var component = this;
        var pmKeys = Object.keys(this.pm);

        for (var i = 0; i < pmKeys.length; i++) {
          var k = pmKeys[i];

          this.$watch("pm." + k, function(newVal, oldVal) {
            if (newVal === oldVal) return;
            
            // let the parent Vue instance know what changed:
            component.$emit("program-member-change", component.pm.id, k, newVal);
          });
        }
      },
    };

  })();
</script>