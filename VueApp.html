<script>
(function(){

//
// Field options
//
var programsAndCommittees = [
  "Communications",
  "Direct Service/Brake Lights",
  "Healthcare For All",
  "Immigration Working Group",
  "Labor Standing",
  "Municipal Action",
  "Socialist Feminist Caucus",
  "Political Education",
  "Socialists Of Color",
  "Tech",
  "Other",
];

var initialTextResponses = [
  "Call Scheduled",
  "Left Town / Not Interested",
  "No Reply",
];

var meetingScheduledResponses = [
  "Meetup Scheduled",
  "Can't/May Attend Later Events",
  "Not Interested",
  //"Other",
];

// Returns a function, that, as long as it continues to be invoked, will not
// be triggered. The function will be called after it stops being called for
// N milliseconds. If `immediate` is passed, trigger the function on the
// leading edge, instead of the trailing.
function debounce(func, wait, immediate) {
	var timeout;
	return function() {
		var context = this, args = arguments;
		var later = function() {
			timeout = null;
			if (!immediate) func.apply(context, args);
		};
		var callNow = immediate && !timeout;
		clearTimeout(timeout);
		timeout = setTimeout(later, wait);
		if (callNow) func.apply(context, args);
	};
};

// *********
// Vue
// *********
Vue.use(VueMaterial.default);
window.app = new Vue({
  el: '#app',
  components: {
    "login-dialog": window.vueComponents.loginDialog,
    "select-program-member": window.vueComponents.selectProgramMember,
    "intake-form": window.vueComponents.intakeForm,
  },
  data: {
    programMembers: [],       
    showLogin: true,
    showSteps: true,
    selectedProgramMemberId: -1,
    presets: {
      initialTextResponses: initialTextResponses,
      programsAndCommittees: programsAndCommittees,
      meetingScheduledResponses: meetingScheduledResponses,
    },
  },
  computed: {
    selectedProgramMember: function() {
      if (!this.programMembers.length) return null;

      var spmId = this.selectedProgramMemberId;
      return this.programMembers.find(function(pm) {
        return pm.id === spmId;
      });
    }
  },
  watch: {},
  methods: {
    onLoginSuccess: function() {
      this.showLogin = false;
      this.getProgramMembers();
    },
    getProgramMembers: function() {
      var app = this;

      google.script.run
        .withSuccessHandler(function(data) {
          app.programMembers = data;
        })
        .getProgramMembers();
    },
    updateProgramMember: debounce(function(update) {
      this.selectedProgramMember[update.changedProp] = update.value;

      console.log(this.selectedProgramMember[update.changedProp])

      google.script.run
         .withSuccessHandler(function(res){
           console.log("save response: ", res);
         })
         .updateProgramMember(this.selectedProgramMember);

    }, 500),
    onProgramMemberSelect: function (programMemberId) {
      this.selectedProgramMemberId = programMemberId;
    },
    onMobilizerChange: function() {
      this.selectedProgramMemberId = -1;
    },
  }
});

})();


</script>