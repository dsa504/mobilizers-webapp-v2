<script>
//
// Field options
//
var programsAndCommittees = [
  "Communications",
  "Direct Service/Brake Lights",
  "Healthcare For All",
  "Immigration Working Group",
  "Labor Standing",
  "Municipal Action",
  "Socialist Feminist Caucus",
  "Political Education",
  "Socialists Of Color",
  "Tech",
  "Other",
];

var initialTextResponses = [
  "Call Scheduled",
  "Left Town / Not Interested",
  "No Reply",
];

var meetingScheduledResponses = [
  "Meetup Scheduled",
  "Can't/May Attend Later Events",
  "Not Interested",
  //"Other",
];

//
// Map of fields to spreadsheet columns
// don't really use the 'type' atm ::shrug::
// 
var columnMap = {
  mobName: { id: "a", type: String },
  pmName: { id: "b", type: String },
  pmPhone: { id: "c", type: String },
  pmEmail: { id: "d", type: String },
  pmAssignedDate : { id: "e", type: String },
  pmAssignedStatus: { id: "f", type: String },
  pronoun: { id: "g", type: String },
  initialTextSent : { id:"h", type: Boolean },
  initialTextResponse : { id:"i", type: String },
  callMade: { id: "j", type: String },
  occupation: { id: "k", type: String },
  skills:{ id: "l", type: String },
  interests: { id: "m", type: Array },
  meetupScheduled: { id: "n", type: String },
  followupTextSent: { id: "o", type: Boolean },
  attendedMeetup: { id: "p", type: Boolean },
  metPm: { id: "q", type: Boolean },
  addToSlack : { id: "r", type: Boolean },
  meetupEvent : { id: "s", type: String },
  sketch: { id: "t", type: Boolean },
}
//
// Alphabet Map (using this so the columnmap is easier to read/match to the spreadsheet) 
//
var alphabet = ["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];
for (var k in columnMap){
  columnMap[k].id = alphabet.indexOf(columnMap[k].id);
}

// *********
// Vue
// *********
Vue.use(VueMaterial.default);
var app = new Vue({
  el: '#app',
  data: {
    activeMobilizer: "",           // int - key value of the currently active mobilizer in mobilizers[]
    activeProgramMember: "",       // int - key of row in formData[] we're editing
    columnMap: columnMap, 
    pw: "",                        // password
    formData: "",                  // data from spreadsheet (this is the data we're modifying with the form)
    formDataLoaded: false,         // flag indicated we've pulled the spreadsheet data
    formOptions: {
      initialTextResponses : initialTextResponses,
      programsAndCommittees : programsAndCommittees,
      meetingScheduledResponses : meetingScheduledResponses,
      showSteps: true,
      showLogin: true,
      showLoginError: false,
    },
    tempData: {                   // note: bc Vue Material will only treat checkboxes correctly if the v-model field is an array, 
       interests: [],             // we use tempData.interests as a intermediate variable between the form and formData
       doneButtonState: ""
    }
  },
  computed: {
    //
    // get an array of all the mobilizers from formData
    //
    mobilizers:{
      get: function() { 
        return this.formData.map(function (d) {
          d[columnMap['mobName'].id]
        });
      },
      set: function(val){
        return val;
      }
    },
    //
    // get an array of program members assigned to the active mobilizer from formData
    //
    programMembers:{
      get: function() { 
        return this.formData
          .filter(function(d){ 
            return d.columnMap.mobName.id === this.activeMobilizer
          })
          .map(function(d, i) {
            return {
              name: d[columnMap.pmName.id],
              id:i,
              textSent : d[columnMap.initialTextSent].id === true,
              callAttempted : d[columnMap.callMade].id !== "",
              sentFollowup: d[columnMap.followupTextSent].id === true,
              attended: d[columnMap.attendedMeetup].id === true
             };
          });
      },
      set: function(val){
        return val;
      }
    },
    //
    // get the details for the active program member from formData, for the program member details "contact card"
    //
    activeProgramMemberData:function(){ 
      var assignedDate = this.formData[this.activeProgramMember][columnMap.pmAssignedDate.id];
      var dueDate = moment(assignedDate).add(7, 'days').format('MM/DD/YYYY');
      var pmData = {
        name : this.formData[this.activeProgramMember][columnMap.pmName.id],
        phone : this.formData[this.activeProgramMember][columnMap.pmPhone.id],
        email : this.formData[this.activeProgramMember][columnMap.pmEmail.id],
        assigned : assignedDate,
        due : dueDate,
        status : this.formData[this.activeProgramMember][columnMap.pmAssignedStatus.id]
      }
      return pmData;
    },
  },
  watch: {
    activeProgramMember: function(){ 
      if(this.activeProgramMember !== ""){
        console.log("Editing Row: " + this.activeProgramMember);
        
        // Vue Material hacks, see note in data
        var interests = this.formData[this.activeProgramMember][columnMap.interests.id];
        if(interests != ''){
          this.tempData.interests = JSON.parse(this.formData[this.activeProgramMember][columnMap.interests.id]);
        } else {
          this.tempData.interests = [];
        }
        
        this.tempData.doneButtonState = this.formData[this.activeProgramMember][columnMap.pmAssignedStatus.id];
        
      }
    },
    activeMobilizer: function(){
      this.activeProgramMember = ''; // reset activeProgramMember when we change mobilizers
    },
    //
    // Vue Materal semi-hacks, see note above
    //
    tempData: {
      interests: function(){
        this.formData[this.activeProgramMember][columnMap.interests.id] = JSON.stringify(this.tempData.interests);
        if(this.formDataLoaded){
          this.putSpreadsheetData();
        }
      },
      doneButtonState: function(){
        var status = this.tempData.doneButtonState;
        console.log(status);
        if( status == "Open"){
          this.formData[this.activeProgramMember][columnMap.pmAssignedStatus.id] = "Open";
        }
        if( status == "Marked Done"){
          this.formData[this.activeProgramMember][columnMap.pmAssignedStatus.id] = "Marked Done";
        }
        if(this.formDataLoaded){
          this.putSpreadsheetData();
        }
      },
    },
    ///
    /// on change, push the data to the spreadsheet
    ///
    formData: function(){ 
        if(this.activeProgramMember != 'undefined' && this.activeProgramMember != null && this.activeProgramMember != ""){
          this.showHideSteps(); // If there's no response to initial text, or they're not interested, hide the rest of the steps
          if(this.formDataLoaded){
            this.putSpreadsheetData();
          }
        }
    },
  },
  methods: {
    //
    // Attempt to login to the backend
    //
    attemptLogin: function(e){  
      google.script.run.withSuccessHandler(this.loginAttempt).tryLogin( this.pw );
    },
    //
    // Login callback
    //
    loginAttempt: function(data){ 
      if(data == "OK"){
         console.log("Logged In!");
         this.formOptions.showLogin = false;
         this.getSpreadsheetData();
      }else{
        console.log("Oops, wrong password.");
        this.formOptions.showLoginError = true;
      }
    },
    //
    // get the spreadsheet data
    //
    getSpreadsheetData: function(){ 
      console.log("Fetching Data...");
      google.script.run.withSuccessHandler( this.onGetSpreadsheetDataSuccess ).getSpreadsheet( this.pw );
    },
    //
    // get spreadsheet callback
    //
    onGetSpreadsheetDataSuccess: function(data){ 
      this.formData = data;
      this.formDataLoaded = true;
    },
    //
    // put the spreadsheet data
    //
    putSpreadsheetData: function(){ 
      var output = this.formData[this.activeProgramMember];
      console.log("sending active row: "+this.activeProgramMember);
      console.log(output);
      google.script.run
        .withSuccessHandler(this.onPutSpreadsheetDataSuccess)
        .updateSpreadsheet(this.columnMap, this.activeProgramMember, output, this.pw);
    },
    //
    // put spreadsheet callback
    //
    onPutSpreadsheetDataSuccess: function () { 
      console.log("data PUT"); 
    },
    //
    // If there's no response to initial text, or they're not interested, hide the rest of the steps
    //
    showHideSteps: function(){
      var initText = this.formData[this.activeProgramMember][columnMap.initialTextResponse.id];
      if (initText == "Call Scheduled" || initText == "") {
        this.formOptions.showSteps = true;
      } else {
        this.formOptions.showSteps = false;
      }
    },
    //
    // Select a Program Member from the table
    //
    onTableSelect: function (item) { 
      if(typeof item != 'undefined' && item != null){ 
        this.activeProgramMember = item.id;
      };
    },
    //
    // Toggle the "Marked as Done" button
    //
    doneButtonToggle: function(state) {
      if( state == "Open"){
        this.tempData.doneButtonState = "Marked Done";
      }
      if( state == "Marked Done"){
        this.tempData.doneButtonState = "Open";
      }
    }
  }
})

//
// helpers & utils
//

// Remove Duplicates in Array 
function uniq(a){var prims={"boolean":{},number:{},string:{}},objs=[];return a.filter(function(item){var type=typeof item;if(type in prims)return prims[type].hasOwnProperty(item)?false:prims[type][item]=true;else return objs.indexOf(item)>=0?false:objs.push(item)})}


</script>